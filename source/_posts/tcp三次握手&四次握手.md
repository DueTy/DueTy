---
title: tcp三次握手&四次挥手
---

### 涉及名词
- SYN(synchronous建立联机) 
- ACK(acknowledgement 确认)
- FIN(finish结束)
- RST(reset重置) 
- URG(urgent紧急)
- Sequence number(顺序号码) 
- Acknowledge number(确认号码)

### 三次握手（建立连接）
![image](https://user-gold-cdn.xitu.io/2019/4/24/16a4e89718f94f91?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)
1. **第一次握手**：客户端（Client，C端）首先向服务端（Server，S端）发起一次数位为SYN=1，并携带seq=x随机数据包的数据，S端接收到SYN知道，C端要建立连接，此时C端进入SYN-SENT（同步已发送）状态
2. **第二次握手**：S端接受到请求后，向C端发送ACK=1，SYN=1，ACK序号为seq=x+1，SYN序号为seq=y的数据包，然后，S端由LISTEN（监听）状态变为SYN-RVCD（同步已接收）状态
3. **第三次握手**：C端收到后判断ACK序号是否正确，即seq=y+1，如果正确，则再向S端发起ACK位数seq=y+1，序号为seq=x+1，以及ACK=1的请求，C端接收后，两端建立连接，双方到达ESTABLISHED（连接建立）状态

### 四次握手（断开连接）
![image](https://user-gold-cdn.xitu.io/2019/4/24/16a4e8e413941b94?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)
1. **第一次握手** ： 客户端 的应用进程先向其 TCP 发出连接释放报文段，并停止在发送数据，主动关闭 TCP 连接。客户端把连接释放报文段首部的终止控制位 FIN 置 1，其序号 seq = u ,它等于前面已传过的数据的最后一个字节的序号加 1 。这时 客户端 进入 FIN-WAIT-1 (终止等待1) 状态，等待 服务器 的确认。（ FIN 报文段即使不携带数据，它也消耗掉一个序号。）
2. **第二次握手**：服务器收到连接释放报文段后即发出确认，确认号 ack = u + 1 ，而这个报文段 自己的序号是 v ,等于 服务器 前面已经传过的数据的最后一个字节的序号加 1 。然后 服务器 就进入 CLOSEWAIT（关闭等待）状态。TCP 服务器进程这时应通知高层应用进程（不确定自己是否还有数据要发送给 客户端（所以是四次不是三次）），因而从 客户端 到 服务器 这个方向的连接就释放了，这时的 TCP 连接处于 半关闭（Half-close）状态，即 客户端 已经没有数据要发送了，但 服务器 若发送数据，客户端仍要接收。也就是说， 服务器 到 客户端 这个方向的连接并未关闭，这个状态可能会持续一段时间。客户端 收到来自 服务器 的确认后，就进入 FIN-WAIT-2(终止等待2) 状态，等待 服务器 发出的连接释放报文段。
3. **第三次握手**：若 服务器 已经没有要向 客户端 发送的数据，其应用进程就通知 TCP 释放连接。这时 服务器发出的连接使用报文段必须使用 FIN = 1。现假设 服务器 的序号为 w（在半关闭状态 服务器 可能又发送了一些数据）。服务器还必须重复上次已发送过的确认号 ack = u + 1。这时 服务器 就进入 LAST-ACK (最后确认) 状态，等待 客户端 的确认。
4. **第四次握手**：客户端 在收到 服务器 的连接释放报文段后，必须对此发出确认。在确认报文段中把 ACK 置 1，确认号 ack = w + 1，而自己的序号是 seq = u + 1（根据 TCP 标准，前面发送过的 FIN 报文段要消耗一个序号）。然后进入到 TIME-WAIT(时间等待) 状态。请注意，TCP 连接现在还没有释放掉。必须经过 时间等待计时器（TIME-WAIT）设置的时间 2MSL 后，客户端 才进入到 CLOSED 状态。时间 MSL 叫做 最长报文段寿命，RFC 793 建议设为 2 分钟。
